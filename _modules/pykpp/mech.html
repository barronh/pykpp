<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pykpp.mech &#8212; pykpp 1.0.0&#39; documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pykpp.mech</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">warnings</span><span class="w"> </span><span class="kn">import</span> <span class="n">warn</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">itg</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot</span> <span class="k">as</span> <span class="n">_plot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.stdfuncs</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.stdfuncs</span><span class="w"> </span><span class="kn">import</span> <span class="n">solar_noon_local</span><span class="p">,</span> <span class="n">solar_noon_utc</span><span class="p">,</span> <span class="n">solar_declination</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">stdfuncs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">_parsefile</span><span class="p">,</span> <span class="n">_reactionstoic</span><span class="p">,</span> <span class="n">_allspc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">_prune_meta_species</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span>
<span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>


<div class="viewcode-block" id="addtojac"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.addtojac">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">addtojac</span><span class="p">(</span><span class="n">rxni</span><span class="p">,</span> <span class="n">reaction</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">allspcs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From parsed reaction, add a jacobian element</span>

<span class="sd">    rxni - reaction list index</span>
<span class="sd">    reaction - reaction tokens</span>
<span class="sd">        dict(reactants = [(stoic, spc), ...],</span>
<span class="sd">             products = [(stoic, spc), ...])</span>

<span class="sd">    Future work should reduce the jacobian size by banding or LU decomp.</span>

<span class="sd">    jac[i,j] = d f[i] / d y[j]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create a list of reactant species names</span>
    <span class="n">rcts</span> <span class="o">=</span> <span class="p">[</span><span class="n">spc</span> <span class="k">for</span> <span class="n">stc</span><span class="p">,</span> <span class="n">spc</span> <span class="ow">in</span> <span class="n">reaction</span><span class="p">[</span><span class="s1">&#39;reactants&#39;</span><span class="p">]]</span>

    <span class="c1"># Create a list of expressions that are multiplied by the</span>
    <span class="c1"># rate constant (e.g., from k*y[0]*y[1] -&gt; y[0]*y[1])</span>
    <span class="n">spcorder</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="s1">&#39;y[</span><span class="si">%d</span><span class="s1">]**(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">allspcs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">spc_</span><span class="p">),</span> <span class="n">stc_</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;**(1.)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;**(+ 1.)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stc_</span><span class="p">,</span> <span class="n">spc_</span> <span class="ow">in</span> <span class="n">reaction</span><span class="p">[</span><span class="s1">&#39;reactants&#39;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="c1"># Iterate over all stoichiometries and spcs names for</span>
    <span class="c1"># reactions and products in reaction</span>
    <span class="k">for</span> <span class="n">role</span><span class="p">,</span> <span class="n">stc</span><span class="p">,</span> <span class="n">spc</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="p">[(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">stc_</span><span class="p">,</span> <span class="n">spc_</span><span class="p">)</span> <span class="k">for</span> <span class="n">stc_</span><span class="p">,</span> <span class="n">spc_</span> <span class="ow">in</span> <span class="n">reaction</span><span class="p">[</span><span class="s1">&#39;reactants&#39;</span><span class="p">]]</span>
        <span class="o">+</span> <span class="p">[(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">stc_</span><span class="p">,</span> <span class="n">spc_</span><span class="p">)</span> <span class="k">for</span> <span class="n">stc_</span><span class="p">,</span> <span class="n">spc_</span> <span class="ow">in</span> <span class="n">reaction</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">]]</span>
    <span class="p">):</span>
        <span class="c1"># Species index in ordered species</span>
        <span class="n">ispc</span> <span class="o">=</span> <span class="n">allspcs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span>

        <span class="c1"># For each reactant, calculate derivative</span>
        <span class="c1"># based on removing that reactant from the</span>
        <span class="c1"># rate</span>
        <span class="k">for</span> <span class="n">rstc</span><span class="p">,</span> <span class="n">rspc</span> <span class="ow">in</span> <span class="n">reaction</span><span class="p">[</span><span class="s1">&#39;reactants&#39;</span><span class="p">]:</span>
            <span class="c1"># Get index of reactant in ordered species</span>
            <span class="n">irspc</span> <span class="o">=</span> <span class="n">allspcs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rspc</span><span class="p">)</span>

            <span class="c1"># Create a copy of the ordered species</span>
            <span class="n">tmpspcorder</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_</span> <span class="k">for</span> <span class="n">i_</span> <span class="ow">in</span> <span class="n">spcorder</span><span class="p">]</span>

            <span class="c1"># Remove this reactant</span>
            <span class="n">tmpspcorder</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">rcts</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rspc</span><span class="p">))</span>

            <span class="c1"># Create an expression to calculate derivative</span>
            <span class="c1"># of reaction</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39; * &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1"> * rate_const[</span><span class="si">%d</span><span class="s1">]&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span> <span class="k">else</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">stc</span><span class="p">,</span> <span class="n">rxni</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="o">+</span> <span class="n">tmpspcorder</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">jac</span><span class="p">[</span><span class="n">ispc</span><span class="p">][</span><span class="n">irspc</span><span class="p">]</span> <span class="ow">and</span> <span class="n">expr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jac</span><span class="p">[</span><span class="n">ispc</span><span class="p">][</span><span class="n">irspc</span><span class="p">]:</span>
                <span class="c1"># The oposite signed expression is already in the jacobian</span>
                <span class="c1"># the sum of the two is 0, so this removes both expressiosn</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
                <span class="k">elif</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Huh?&#39;</span><span class="p">)</span>
                <span class="n">jac</span><span class="p">[</span><span class="n">ispc</span><span class="p">][</span><span class="n">irspc</span><span class="p">]</span> <span class="o">=</span> <span class="n">jac</span><span class="p">[</span><span class="n">ispc</span><span class="p">][</span><span class="n">irspc</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="n">sign</span> <span class="o">+</span> <span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add expression to the jacobian</span>
                <span class="n">jac</span><span class="p">[</span><span class="n">ispc</span><span class="p">][</span><span class="n">irspc</span><span class="p">]</span> <span class="o">+=</span> <span class="n">expr</span></div>


<div class="viewcode-block" id="Mech"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Mech</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mech object must be able to interpret kpp inputs</span>
<span class="sd">    and translate the results to create a reaction</span>
<span class="sd">    function (Mech.dy), a jacobian (Mech.ddy), and</span>
<span class="sd">    run the model (Mech.run)</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Mech.add_world_updater"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.add_world_updater">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_world_updater</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">updater</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updaters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updater</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mech.add_func_updater"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.add_func_updater">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_func_updater</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_world_updater</span><span class="p">(</span><span class="n">stdfuncs</span><span class="o">.</span><span class="n">func_updater</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">))</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mechname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hv&#39;</span><span class="p">,</span> <span class="s1">&#39;PROD&#39;</span><span class="p">,</span> <span class="s1">&#39;EMISSION&#39;</span><span class="p">],</span>
        <span class="n">incr</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">monitor_incr</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span> <span class="n">timeunit</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">add_default_funcs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">doirr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        path              - path to kpp inputs</span>
<span class="sd">        mechname          - name for output</span>
<span class="sd">        keywords          - ignore certain keywords from reactants in</span>
<span class="sd">                            calculate reaction rates</span>
<span class="sd">        timeunit          - &#39;local&#39; or &#39;utc&#39;</span>
<span class="sd">        add_default_funcs - if True, then add Update_THETA, Update_SUN, and</span>
<span class="sd">                            Update_M if THETA, SUN, or M appear in the rate</span>
<span class="sd">                            constant expressions.</span>
<span class="sd">        incr              - default functions will be called when simulated</span>
<span class="sd">                            time has progressed more than incr seconds</span>
<span class="sd">        monitor_incr      - If monitor_incr is not None, add a monitor function</span>
<span class="sd">                            updaters, so it has a special optional keyword</span>
<span class="sd">        doirr             - save reaction rates for further analysis</span>
<span class="sd">        verbose           - add printing</span>

<span class="sd">        Special functions (e.g., Update_World) for physical environment</span>
<span class="sd">        can be added through PY_INIT in the definiton file e.g.,</span>

<span class="sd">        #MODEL      small_strato</span>
<span class="sd">        #INTEGRATOR lsoda</span>
<span class="sd">        #INLINE PY_INIT</span>
<span class="sd">        TSTART = (12*3600)</span>
<span class="sd">        TEND = TSTART + (3*24*3600)</span>
<span class="sd">        DT = 0.25*3600</span>
<span class="sd">        TEMP = 270</span>
<span class="sd">        updated_phys = -inf</span>
<span class="sd">        temp_times = array([TSTART, TEND])</span>
<span class="sd">        temps = array([270., 290.])</span>
<span class="sd">        press_times = array([TSTART, TEND])</span>
<span class="sd">        pressures = array([1013.25, 1050.])</span>

<span class="sd">        def NewUpdater(mech, world):</span>
<span class="sd">            global updated_phys</span>
<span class="sd">            global temp_times</span>
<span class="sd">            global temps</span>
<span class="sd">            global press_times</span>
<span class="sd">            global pressures</span>
<span class="sd">            t = world[&#39;t&#39;]</span>

<span class="sd">            if abs(t - updated_phys) &gt; 1200.:</span>
<span class="sd">                world[&#39;TEMP&#39;] = interp(t, temp_times, temps)</span>
<span class="sd">                world[&#39;P&#39;] = interp(t, press_times, pressures)</span>
<span class="sd">                updated_phys = t</span>
<span class="sd">            Update_SUN(world)</span>
<span class="sd">            # Note that Update_RATE should be called or</span>
<span class="sd">            # rates will never be evaluated</span>
<span class="sd">            Update_RATE(mech, world)</span>

<span class="sd">        add_world_updater(NewUpdater)</span>
<span class="sd">        #ENDINLINE</span>

<span class="sd">        see Mech.resetworld for special values that can be added</span>
<span class="sd">        to F90_INIT or INITVALUES to control the environment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_default_funcs</span> <span class="o">=</span> <span class="n">add_default_funcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputirr</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updaters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incr</span> <span class="o">=</span> <span class="n">incr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_incr</span> <span class="o">=</span> <span class="n">monitor_incr</span>
        <span class="c1"># Create a world namespace to store</span>
        <span class="c1"># variables for calculating chemistry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">world</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Add functions to world for easier parsing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;add_world_updater&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_world_updater</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;add_func_updater&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_func_updater</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;add_constraint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_constraint</span>

        <span class="c1"># Set mechanism name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mechname</span><span class="p">(</span><span class="n">mechname</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># A default mechanism has no reactions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">EQUATIONS</span><span class="o">=</span><span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span> <span class="o">=</span> <span class="n">_parsefile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># For rxn dict-like objects in EQUATIONS</span>
        <span class="c1"># remove reactants that are keywords</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;EQUATIONS&#39;</span><span class="p">]:</span>
            <span class="n">_prune_meta_species</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="o">*</span><span class="n">keywords</span><span class="p">)</span>

        <span class="c1"># Find all spcs either explicitly defined or</span>
        <span class="c1"># referenced in reactions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span> <span class="o">=</span> <span class="n">_allspc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">)</span>

        <span class="c1"># Enable IRR - place holder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doirr</span> <span class="o">=</span> <span class="n">doirr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_history</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Store a copy of the number of species</span>
        <span class="n">nspcs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">)</span>

        <span class="c1"># Print number of species and reactions</span>
        <span class="c1"># and details of each if verbose = True</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_spcidx</span><span class="p">()</span>

        <span class="c1"># Execute INIT code in the context of world</span>
        <span class="k">if</span> <span class="s1">&#39;INIT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">initcode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;INIT&#39;</span><span class="p">]:</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">initcode</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">world</span><span class="p">)</span>

        <span class="c1"># Do not apply CFACTOR to these key words even</span>
        <span class="c1"># if they are defined in INITVALUES</span>
        <span class="n">nocfactorkeys</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;CFACTOR&#39;</span><span class="p">,</span> <span class="s1">&#39;TEMP&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;StartDate&#39;</span><span class="p">,</span> <span class="s1">&#39;StartJday&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Latitude_Degrees&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude_Radians&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude_Degrees&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Longitude_Radians&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Execute the INITVALUES code in the context</span>
        <span class="c1"># of the world</span>
        <span class="k">if</span> <span class="s1">&#39;INITVALUES&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;INITVALUES&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">world</span><span class="p">)</span>

        <span class="c1"># Multiply all input species by CFACTOR</span>
        <span class="n">cfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_cfactor</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CFACTOR&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nocfactorkeys</span><span class="p">:</span>
                <span class="n">world</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">cfactor</span>

        <span class="c1"># Add utility functions to the world</span>
        <span class="k">if</span> <span class="s1">&#39;UTIL&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">utilcode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;UTIL&#39;</span><span class="p">]:</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">utilcode</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">world</span><span class="p">)</span>

        <span class="c1"># Add RATES functions to the world</span>
        <span class="k">if</span> <span class="s1">&#39;RATES&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ratecode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;RATES&#39;</span><span class="p">]:</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">ratecode</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">world</span><span class="p">)</span>

        <span class="c1"># Prepare to monitor expressions</span>
        <span class="k">if</span> <span class="s1">&#39;MONITOR&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">monitor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;MONITOR&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="n">monitor</span> <span class="o">=</span> <span class="p">[</span><span class="n">k_</span> <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">monitor</span> <span class="k">if</span> <span class="n">k_</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_expr</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k_</span><span class="p">)</span> <span class="k">if</span> <span class="n">k_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">monitor</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_expr</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">ik</span> <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">)])</span>

        <span class="c1"># Prepare to archive expressions</span>
        <span class="k">if</span> <span class="s1">&#39;LOOKAT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;LOOKAT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ALL&#39;</span><span class="p">:</span>
                <span class="n">lookat</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lookat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;LOOKAT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                <span class="n">lookat</span> <span class="o">=</span> <span class="p">[</span><span class="n">k_</span> <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">lookat</span> <span class="k">if</span> <span class="n">k_</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;ALL&#39;</span> <span class="ow">in</span> <span class="n">lookat</span><span class="p">:</span>
                    <span class="n">lookat</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">lookat</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;ALL&#39;</span><span class="p">))</span>
                    <span class="n">lookat</span> <span class="o">=</span> <span class="n">lookat</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lookat</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lookat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lookat</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">)</span>

        <span class="c1"># initialize non-defined species as ALL_SPC keyword</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_all_spc</span><span class="p">()</span>

        <span class="c1"># Create dy expression and expression string (for review)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dy_exp</span><span class="p">()</span>

        <span class="c1"># Create rate and drate expression and expression strings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_rate_exp</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parsed_world</span> <span class="o">=</span> <span class="n">world</span>
        <span class="k">del</span> <span class="n">world</span><span class="p">[</span><span class="s1">&#39;add_world_updater&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">world</span><span class="p">[</span><span class="s1">&#39;add_func_updater&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">world</span><span class="p">[</span><span class="s1">&#39;add_constraint&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeunit</span> <span class="o">=</span> <span class="n">timeunit</span>

        <span class="c1"># set over all time increment</span>
        <span class="c1"># self.set_incr(incr)</span>

        <span class="c1"># add default funcs is appropriate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_funcs</span><span class="p">()</span>

        <span class="c1"># Working on reorder and efficiency</span>
        <span class="c1"># so far lsoda chokes on packed format</span>
        <span class="c1"># so far lsoda chokes on baned format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">banded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doreorder</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doreorder</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">banded</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed</span><span class="p">:</span>
            <span class="c1"># Initialize clean world</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetworld</span><span class="p">()</span>
            <span class="n">neworder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetworld</span><span class="p">()</span>

        <span class="c1"># Initialize clean world</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetworld</span><span class="p">()</span>

<div class="viewcode-block" id="Mech.set_incr"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.set_incr">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_incr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets incr property</span>

<span class="sd">        incr - time increment (in rate unit); if None, select minimum time from</span>
<span class="sd">               updaters and constraints</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">incr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">incr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span>
                <span class="n">func</span><span class="o">.</span><span class="n">incr</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updaters</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">incr</span> <span class="o">=</span> <span class="n">incr</span></div>

<div class="viewcode-block" id="Mech.add_funcs"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.add_funcs">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_funcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add default functions (e.g., Update_THETA, Update_SUN, Update_M,</span>
<span class="sd">        Monitor) if they are needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">usetuv</span> <span class="o">=</span> <span class="s1">&#39;TUV_J&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_const_exp_str</span>
        <span class="n">usetheta</span> <span class="o">=</span> <span class="s1">&#39;THETA&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_const_exp_str</span>
        <span class="n">usesun</span> <span class="o">=</span> <span class="s1">&#39;SUN&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_const_exp_str</span>
        <span class="n">usem</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># usem = (</span>
        <span class="c1">#     &#39;M&#39; in self.rate_const_exp_str</span>
        <span class="c1">#     or &#39;N2&#39; in self.rate_const_exp_str</span>
        <span class="c1">#     or &#39;O2&#39; in self.rate_const_exp_str</span>
        <span class="c1"># )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usetheta</span> <span class="o">=</span> <span class="n">usetheta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usesun</span> <span class="o">=</span> <span class="n">usesun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usem</span> <span class="o">=</span> <span class="n">usem</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_incr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_world_updater</span><span class="p">(</span><span class="n">stdfuncs</span><span class="o">.</span><span class="n">func_updater</span><span class="p">(</span>
                <span class="n">stdfuncs</span><span class="o">.</span><span class="n">Monitor</span><span class="p">,</span> <span class="n">incr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_incr</span><span class="p">,</span> <span class="n">allowforce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
            <span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_default_funcs</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">add_func</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">usetheta</span><span class="p">,</span> <span class="n">stdfuncs</span><span class="o">.</span><span class="n">Update_THETA</span><span class="p">),</span>
            <span class="p">(</span><span class="n">usesun</span><span class="p">,</span> <span class="n">stdfuncs</span><span class="o">.</span><span class="n">Update_SUN</span><span class="p">),</span>
            <span class="p">(</span><span class="n">usem</span><span class="p">,</span> <span class="n">stdfuncs</span><span class="o">.</span><span class="n">Update_M</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">check</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">add_func</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check</span> <span class="ow">and</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updaters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_world_updater</span><span class="p">(</span><span class="n">stdfuncs</span><span class="o">.</span><span class="n">func_updater</span><span class="p">(</span>
                    <span class="n">func</span><span class="p">,</span> <span class="n">incr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">incr</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
                <span class="p">))</span></div>

<div class="viewcode-block" id="Mech.set_all_spc"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.set_all_spc">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_all_spc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Any undefined species are set to ALL_SPEC keyword</span>
<span class="sd">        or 0 if ALL_SPEC is undefined</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span>
        <span class="n">all_spec</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ALL_SPEC&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">world</span><span class="p">:</span>
                <span class="n">world</span><span class="p">[</span><span class="n">spc</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_spec</span></div>

<div class="viewcode-block" id="Mech.set_rate_exp"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.set_rate_exp">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_rate_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function serves three major goals:</span>

<span class="sd">        1) Define the rate_const_exp and rate_const_exp_str</span>
<span class="sd">           rate_const_exp - is evaluated to calculate all rate coefficients</span>
<span class="sd">        2) Define the rate_exp and rate_exp_str</span>
<span class="sd">           rate_exp - is evaluated to calculate all reaction rates</span>
<span class="sd">        3) Define drate_exp, fill_drate_exp (and _str&#39;s)</span>
<span class="sd">           drate_exp - can be evaluated to calculate the derivative of the</span>
<span class="sd">                       rate_exp with respect to y. This is currently</span>
<span class="sd">                       deprecated in favor of fill_drate_exp</span>
<span class="sd">           fill_drate_exp - can be executed to fill the drate_per_dspc array,</span>
<span class="sd">                       which must exist. This fills the same roll as drate_exp,</span>
<span class="sd">                       but is much faster because it only allocates the memory</span>
<span class="sd">                       once.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store a copy of the number of species</span>
        <span class="n">nspcs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">)</span>
        <span class="n">nrxns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;EQUATIONS&#39;</span><span class="p">])</span>
        <span class="n">world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span>
        <span class="c1"># Create an empty copy of rate constant expressions (rate_const_exp)</span>
        <span class="c1"># and rate expressions (rate_exp; e.g., rate_const_exp * y[0] * y[1])</span>
        <span class="c1"># and rate derivatives with respect to a species (self.drate_exp)</span>
        <span class="n">rate_const_exp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rate_exp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">drate_exp</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspcs</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspcs</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_rate_const_exp_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RCONST&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rxni</span><span class="p">,</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;EQUATIONS&#39;</span><span class="p">]):</span>
            <span class="n">rate_const_exp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reaction</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">])</span>
            <span class="n">spcorder</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="s1">&#39;y[</span><span class="si">%d</span><span class="s1">]**(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">spc_</span><span class="p">),</span> <span class="n">stc_</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;**(1.)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;**(1.)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">stc_</span><span class="p">,</span> <span class="n">spc_</span> <span class="ow">in</span> <span class="n">reaction</span><span class="p">[</span><span class="s1">&#39;reactants&#39;</span><span class="p">]]</span>
            <span class="n">rate_exp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; * &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;rate_const[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">rxni</span><span class="p">]</span> <span class="o">+</span> <span class="n">spcorder</span><span class="p">))</span>
            <span class="n">addtojac</span><span class="p">(</span><span class="n">rxni</span><span class="p">,</span> <span class="n">reaction</span><span class="p">,</span> <span class="n">drate_exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">)</span>

        <span class="n">drate_exp</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">drate_exp</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drate_exp_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;array([&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">drate_exp</span>
            <span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;])&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drate_per_dspc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nspcs</span><span class="p">,</span> <span class="n">nspcs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_drate_exp_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;drate_per_dspc[</span><span class="si">%i</span><span class="s1">,</span><span class="si">%i</span><span class="s1">] = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span>
            <span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">drate_exp</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_drate_exp</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill_drate_exp_str</span><span class="p">,</span> <span class="s1">&#39;drate_exp&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drate_exp</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drate_exp_str</span><span class="p">,</span> <span class="s1">&#39;drate_exp&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_const_exp_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;array([&#39;</span> <span class="o">+</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rate_const_exp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;])&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_const_exp</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rate_const_exp_str</span><span class="p">,</span> <span class="s1">&#39;rate_const_exp&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_rate_const_exp</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill_rate_const_exp_str</span> <span class="o">+</span> <span class="s1">&#39;rate_const[:] = &#39;</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_const_exp_str</span><span class="p">,</span> <span class="s1">&#39;fill_rate_const_exp&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrxns</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_exp_str</span> <span class="o">=</span> <span class="s1">&#39;array([&#39;</span> <span class="o">+</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rate_exp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;])&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_rate_exp_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s1">&#39;rates[</span><span class="si">%d</span><span class="s1">] = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ri_rassign</span> <span class="k">for</span> <span class="n">ri_rassign</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rate_exp</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_rate_exp</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill_rate_exp_str</span><span class="p">,</span> <span class="s1">&#39;fill_rate_exp&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_exp</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_exp_str</span><span class="p">,</span> <span class="s1">&#39;rate_exp&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mech.set_dy_exp"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.set_dy_exp">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_dy_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Store a copy of the number of species</span>
        <span class="n">nspcs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">)</span>
        <span class="n">world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span>
        <span class="c1"># Store a temporary copy of the stoichiometry in each reaction</span>
        <span class="n">dy_stoic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">:</span>
            <span class="n">dy_stoic</span><span class="p">[</span><span class="n">spc</span><span class="p">]</span> <span class="o">=</span> <span class="n">_reactionstoic</span><span class="p">(</span><span class="n">spc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;EQUATIONS&#39;</span><span class="p">])</span>

        <span class="c1"># Add each reaction rate expression to the dy</span>
        <span class="c1"># for the species in the reacton</span>
        <span class="n">dy_exp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspcs</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">si</span><span class="p">,</span> <span class="n">spc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ri</span><span class="p">,</span> <span class="n">stoic</span> <span class="ow">in</span> <span class="n">dy_stoic</span><span class="p">[</span><span class="n">spc</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dy_exp</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s1">&#39; + </span><span class="si">%f</span><span class="s1"> * rates[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stoic</span><span class="p">,</span> <span class="n">ri</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+ -1.000000 * &#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+ 1.000000 * &#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span>

        <span class="n">dy_exp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">dy_</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">dy_</span> <span class="k">for</span> <span class="n">dy_</span> <span class="ow">in</span> <span class="n">dy_exp</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy_exp_str</span> <span class="o">=</span> <span class="s1">&#39;array([&#39;</span> <span class="o">+</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dy_exp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;])&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_dy_exp_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s1">&#39;dy[</span><span class="si">%d</span><span class="s1">] = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">yi_assign</span> <span class="k">for</span> <span class="n">yi_assign</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dy_exp</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy_exp</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dy_exp_str</span><span class="p">,</span> <span class="s1">&#39;dy_exp&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_dy_exp</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fill_dy_exp_str</span><span class="p">,</span> <span class="s1">&#39;fill_dy_exp&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mech.set_spcidx"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.set_spcidx">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_spcidx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create references to spc in conc array</span>
        <span class="k">for</span> <span class="n">si</span><span class="p">,</span> <span class="n">spcn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;ind_&#39;</span> <span class="o">+</span> <span class="n">spcn</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;NSPCS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mech.set_mechname"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.set_mechname">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_mechname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mechname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mechname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Heuristically determine the mechanism name</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,)):</span>
                <span class="c1"># Parse kpp inputs and store the results</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mechname</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mechname</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mechname</span> <span class="o">=</span> <span class="n">mechname</span></div>

<div class="viewcode-block" id="Mech.Update_World"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.Update_World">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">Update_World</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forceupdate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        world - dictionary defining current state</span>
<span class="sd">        forceupdate - boolean that forces all functions to update</span>
<span class="sd">        Calls</span>
<span class="sd">            + user added functions (added using add_world_updater)</span>
<span class="sd">            update_func_world(world)</span>
<span class="sd">            Update_RATE(mech, world)</span>

<span class="sd">        *Note: Update_SUN, Update_THETA, and Update_M can be added by</span>
<span class="sd">               the mechanism heuristically.</span>

<span class="sd">        see these functions for more details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">world</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span>
        <span class="n">time2update</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updaters</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">updatedf</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">forceupdate</span><span class="p">)</span>
            <span class="n">time2update</span> <span class="o">=</span> <span class="n">time2update</span> <span class="ow">or</span> <span class="n">updatedf</span>

        <span class="k">if</span> <span class="n">time2update</span> <span class="ow">or</span> <span class="p">(</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_updated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">incr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">world</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated</span><span class="p">,</span> <span class="s1">&#39;Updating world&#39;</span><span class="p">)</span>
            <span class="n">stdfuncs</span><span class="o">.</span><span class="n">update_func_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_rate_const</span><span class="p">()</span></div>

<div class="viewcode-block" id="Mech.update_rate_const"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.update_rate_const">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_rate_const</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;rate_const&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_const</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fill_rate_const_exp</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mech.resetworld"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.resetworld">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">resetworld</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets the world to the parsed state and then adds default</span>
<span class="sd">        values that control the SUN and THETA (solar angle)</span>

<span class="sd">        Special values can be added to INITVALUES or F90_INIT</span>
<span class="sd">        to control solar properties</span>
<span class="sd">            StartDate = datetime.today()</span>
<span class="sd">            StartJday = int(StartDate.strftime(&#39;%j&#39;))</span>
<span class="sd">            Latitude_Degrees = 45.</span>
<span class="sd">            # if Latitude_Radians is provided: degrees(Latitude_Radians)</span>
<span class="sd">            Latitude_Radians = radians(Latitude_Degrees)</span>
<span class="sd">            SunRise = 4.5 or noon - degrees(</span>
<span class="sd">                arccos(-tan(LatRad) * tan(SolarDeclination))</span>
<span class="sd">            ) / 15.</span>
<span class="sd">            SunSet  = 19.5 or noon - degrees(</span>
<span class="sd">                arccos(-tan(LatRad) * tan(SolarDeclination))</span>
<span class="sd">            ) / 15.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsed_world</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Latitude_Radians&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">world</span><span class="p">:</span>
            <span class="n">LatDeg</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Latitude_Degrees&#39;</span><span class="p">,</span> <span class="mf">45.</span><span class="p">)</span>
            <span class="n">LatRad</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;Latitude_Radians&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">LatDeg</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s1">&#39;Latitude_Degrees&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">world</span><span class="p">:</span>
            <span class="n">LatRad</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;Latitude_Radians&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">45.</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;Longitude_Radians&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">world</span><span class="p">:</span>
            <span class="n">LonDeg</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Longitude_Degrees&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="n">LonRad</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;Longitude_Radians&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">LonDeg</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s1">&#39;Longitude_Degrees&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">world</span><span class="p">:</span>
            <span class="n">LonRad</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;Longitude_Radians&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">0.</span><span class="p">))</span>

        <span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="mf">101325.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">usetheta</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">usesun</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s1">&#39;StartDate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">world</span>
            <span class="ow">and</span> <span class="s1">&#39;StartJday&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">world</span>
        <span class="p">):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;WARN: Using SunRise and SunSet of 4.5 and 19.5 (&#39;</span>
                 <span class="o">+</span> <span class="s1">&#39;approximately JulianDay 145 and Latitude 45 degrees N)&#39;</span><span class="p">)</span>
            <span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;SunRise&#39;</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">)</span>
            <span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;SunSet&#39;</span><span class="p">,</span> <span class="mf">19.5</span><span class="p">)</span>
            <span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;StartJday&#39;</span><span class="p">,</span> <span class="mi">145</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;StartJday&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">world</span><span class="p">:</span>
                <span class="n">StartDate</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;StartDate&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime.today()&#39;</span><span class="p">)</span>
                <span class="n">StartDate</span> <span class="o">=</span> <span class="n">world</span><span class="p">[</span><span class="s1">&#39;StartDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">StartDate</span><span class="p">)</span>
                <span class="n">StartJday</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="s1">&#39;StartJday&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">StartDate</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%j&#39;</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">StartJday</span> <span class="o">=</span> <span class="n">world</span><span class="p">[</span><span class="s1">&#39;StartJday&#39;</span><span class="p">]</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">StartJday</span> <span class="o">//</span> <span class="mi">1000</span>
                <span class="n">jday</span> <span class="o">=</span> <span class="n">StartJday</span> <span class="o">%</span> <span class="mi">1000</span>
                <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">year</span> <span class="o">=</span> <span class="n">today</span><span class="o">.</span><span class="n">year</span>
                    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Assuming current year </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">year</span><span class="p">)</span>
                <span class="n">StartDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">jday</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;TSTART&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">world</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Assuming solar noon TSTART&#39;</span><span class="p">)</span>
                <span class="n">world</span><span class="p">[</span><span class="s1">&#39;TSTART&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">12.</span> <span class="o">*</span> <span class="mf">3600.</span>
            <span class="k">if</span> <span class="s1">&#39;TEND&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">world</span><span class="p">:</span>
                <span class="n">world</span><span class="p">[</span><span class="s1">&#39;TEND&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">12.</span> <span class="o">*</span> <span class="mf">3600.</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Assuming solar noon TEND&#39;</span><span class="p">)</span>

            <span class="n">SolarDeclination</span> <span class="o">=</span> <span class="n">solar_declination</span><span class="p">(</span>
                <span class="n">StartJday</span>
                <span class="o">+</span> <span class="p">((</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;TSTART&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">world</span><span class="p">[</span><span class="s1">&#39;TEND&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="mf">3600.</span><span class="p">)</span> <span class="o">//</span> <span class="mi">24</span>
            <span class="p">)</span>
            <span class="n">half_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">LatRad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">SolarDeclination</span><span class="p">))</span>
            <span class="p">)</span> <span class="o">/</span> <span class="mf">15.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeunit</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="n">solar_noon</span> <span class="o">=</span> <span class="n">solar_noon_local</span><span class="p">(</span><span class="n">LonDeg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeunit</span> <span class="o">==</span> <span class="s1">&#39;utc&#39;</span><span class="p">:</span>
                <span class="n">solar_noon</span> <span class="o">=</span> <span class="n">solar_noon_utc</span><span class="p">(</span><span class="n">LonDeg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;timeunit must be either &quot;local&quot; or &quot;utc&quot;&#39;</span><span class="p">)</span>
            <span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;SunRise&#39;</span><span class="p">,</span> <span class="n">solar_noon</span> <span class="o">-</span> <span class="n">half_day</span><span class="p">)</span>
            <span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;SunSet&#39;</span><span class="p">,</span> <span class="n">solar_noon</span> <span class="o">+</span> <span class="n">half_day</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usetheta</span><span class="p">:</span>
                <span class="n">world</span><span class="p">[</span><span class="s1">&#39;SolarDeclination_Radians&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SolarDeclination</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;DT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">incr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;MONITOR_DT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;DT&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updaters</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;allspcs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_all_spc</span><span class="p">()</span></div>

<div class="viewcode-block" id="Mech.summary"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.summary">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return a string with species number, reaction number, and</span>
<span class="sd">        string representations of each</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">spcstr</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">)</span>
            <span class="n">rxnstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_rxn_strs</span><span class="p">())</span>
            <span class="n">initstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Initial Variables:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;INIT&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">initvaluesstr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Initial Concentrations:</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;INITVALUES&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spcstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">rxnstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">initstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">initvaluesstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39;Species: </span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Reactions: </span><span class="si">%d%s%s%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">),</span> <span class="n">spcstr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_rxn_strs</span><span class="p">()),</span> <span class="n">rxnstr</span><span class="p">,</span>
               <span class="n">initstr</span><span class="p">,</span> <span class="n">initvaluesstr</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Mech.get_rxn_strs"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.get_rxn_strs">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_rxn_strs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate reaction string representations from parsed</span>
<span class="sd">        reaction  objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;*&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">spc</span><span class="p">]</span> <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="nb">format</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">stc</span><span class="p">),</span> <span class="n">fmt</span><span class="p">),</span> <span class="n">spc</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">stc</span><span class="p">,</span> <span class="n">spc</span> <span class="ow">in</span> <span class="n">rxn</span><span class="p">[</span><span class="s1">&#39;reactants&#39;</span><span class="p">]</span>
            <span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;*&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">spc</span><span class="p">]</span> <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="nb">format</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">stc</span><span class="p">),</span> <span class="n">fmt</span><span class="p">),</span> <span class="n">spc</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">stc</span><span class="p">,</span> <span class="n">spc</span> <span class="ow">in</span> <span class="n">rxn</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">]</span>
            <span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">rxn</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;EQUATIONS&#39;</span><span class="p">]</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="Mech.print_rxns"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.print_rxns">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_rxns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print reaction stings joined by line returns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_rxn_strs</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Mech.print_monitor"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.print_monitor">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;{t:</span><span class="si">%.0f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">spci</span><span class="p">,</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_expr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spci</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">spc</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">spci</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_cfactor</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;,</span><span class="si">%s</span><span class="s1">:</span><span class="si">%.2G</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spc</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mech.output"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.output">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">outpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mechname</span> <span class="o">+</span> <span class="s1">&#39;.pykpp.tsv&#39;</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Mech.get_output"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.get_output">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Mech.archive"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.archive">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lookat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookat</span>
        <span class="k">if</span> <span class="s1">&#39;t&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lookat</span><span class="p">:</span>
            <span class="n">lookat</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">lookat</span>
        <span class="k">if</span> <span class="s1">&#39;P&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lookat</span> <span class="ow">and</span> <span class="s1">&#39;P&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">:</span>
            <span class="n">lookat</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">lookat</span>
        <span class="k">if</span> <span class="s1">&#39;TEMP&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lookat</span> <span class="ow">and</span> <span class="s1">&#39;TEMP&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">:</span>
            <span class="n">lookat</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;TEMP&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">lookat</span>
        <span class="k">if</span> <span class="s1">&#39;CFACTOR&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lookat</span> <span class="ow">and</span> <span class="s1">&#39;CFACTOR&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">:</span>
            <span class="n">lookat</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;CFACTOR&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">lookat</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_archive&#39;</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">l_</span> <span class="k">for</span> <span class="n">l_</span> <span class="ow">in</span> <span class="n">lookat</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span>
        <span class="n">cfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_cfactor</span>
        <span class="n">outvals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lookat</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">cfactor</span>
            <span class="n">outvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%.8e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v_</span> <span class="k">for</span> <span class="n">v_</span> <span class="ow">in</span> <span class="n">outvals</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outfile</span></div>

    <span class="c1"># def monitor(self, y, t):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Print state at t</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     time_since_print = t - getattr(self, &#39;monitor_time&#39;, 0)</span>
    <span class="c1">#     if time_since_print &gt;= self.world[&#39;MONITOR_DT&#39;]:</span>
    <span class="c1">#         self.print_monitor(y, t)</span>
    <span class="c1">#         self.monitor_time = t</span>
    <span class="c1">#         if self.doirr:</span>
    <span class="c1">#             self.rate_history.append(rates)</span>

<div class="viewcode-block" id="Mech.dy"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.dy">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">dy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that returns the change in species</span>
<span class="sd">        with respect to time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_y_from_y</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Update_World</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
        <span class="n">rate_const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_const</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_exp</span><span class="p">)</span>
        <span class="c1"># rates = self.arates</span>
        <span class="c1"># exec(self.fill_rate_exp)</span>
        <span class="c1"># dy = out = self.ady</span>
        <span class="c1"># exec(self.fill_dy_exp)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dy_exp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">[:]</span></div>

<div class="viewcode-block" id="Mech.reorder"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.reorder">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">reorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Update_World</span><span class="p">()</span>
        <span class="n">nspcs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_y_from_world</span><span class="p">()</span>
        <span class="n">y</span><span class="p">[:]</span> <span class="o">*=</span> <span class="mi">0</span>
        <span class="n">y</span><span class="p">[:]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">drate_per_dspc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drate_per_dspc</span>
        <span class="n">rate_const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_const</span>
        <span class="n">rate_const</span><span class="p">[:]</span> <span class="o">*=</span> <span class="mi">0</span>
        <span class="n">rate_const</span><span class="p">[:]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fill_drate_exp</span><span class="p">)</span>
        <span class="n">inmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drate_per_dspc</span>
        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">inmatrix</span><span class="p">[:]</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">density</span> <span class="o">=</span> <span class="n">nonzero</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">nonzero</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">densityasc</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">neworder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
            <span class="n">densityasc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="mi">2</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">densityasc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">])</span>
        <span class="n">from_left</span> <span class="o">=</span> <span class="n">nonzero</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">from_right</span> <span class="o">=</span> <span class="n">nonzero</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">from_bottom</span> <span class="o">=</span> <span class="n">nonzero</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">from_top</span> <span class="o">=</span> <span class="n">nonzero</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">neworder</span> <span class="o">=</span> <span class="p">(</span><span class="n">from_bottom</span> <span class="o">-</span> <span class="n">from_top</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">neworder</span> <span class="o">=</span> <span class="p">(</span><span class="n">from_left</span> <span class="o">-</span> <span class="n">from_right</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">testmatrix</span> <span class="o">=</span> <span class="n">inmatrix</span><span class="p">[</span><span class="n">neworder</span><span class="p">][:,</span> <span class="n">neworder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns ml and mu, the lower and upper band sizes of a.&quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">testmatrix</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">ml</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">nrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">ml</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span>
                <span class="k">break</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">mu</span> <span class="o">=</span> <span class="n">k</span>
                <span class="k">break</span>
        <span class="n">subd</span> <span class="o">=</span> <span class="n">ml</span>
        <span class="n">superd</span> <span class="o">=</span> <span class="n">mu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">neworder</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_spcidx</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dy_exp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_rate_exp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ml</span> <span class="o">=</span> <span class="n">subd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">superd</span>
        <span class="k">return</span> <span class="n">neworder</span><span class="p">,</span> <span class="n">subd</span><span class="p">,</span> <span class="n">superd</span>

        <span class="n">drate_per_dspc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drate_per_dspc</span>
        <span class="n">rate_const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_const</span>
        <span class="n">drate_per_dspc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drate_per_dspc</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fill_drate_exp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">subd</span><span class="p">,</span> <span class="n">nspcs</span><span class="p">):</span>
            <span class="k">assert</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">drate_per_dspc</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">superd</span><span class="p">,</span> <span class="n">nspcs</span><span class="p">):</span>
            <span class="k">assert</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">drate_per_dspc</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">neworder</span><span class="p">,</span> <span class="n">subd</span><span class="p">,</span> <span class="n">superd</span></div>

<div class="viewcode-block" id="Mech.ddy"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.ddy">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">ddy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the derivative of the species change rate with</span>
<span class="sd">        respect to species</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_y_from_y</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">rate_const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_const</span>
        <span class="c1"># out = eval(self.drate_exp)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">drate_per_dspc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drate_per_dspc</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fill_drate_exp</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">banded</span><span class="p">:</span>
            <span class="n">diagonals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">di</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ml</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">before</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="n">d</span>
                    <span class="n">after</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">after</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span>
                    <span class="n">before</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">after</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">before</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">diagonals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">d</span><span class="p">)),</span>
                              <span class="n">after</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">diagonals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed</span><span class="p">:</span>
            <span class="n">nr</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">jac_packed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                <span class="n">myr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">):</span>
                    <span class="n">jac_packed</span><span class="p">[</span><span class="n">myr</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">jac_packed</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Mech.get_y"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.get_y">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a vector of species values in order of self.allspcs</span>
<span class="sd">        Optional:</span>
<span class="sd">            world - special dictionary to create vector (defaults to</span>
<span class="sd">                    self.world)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">world</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">eval</span><span class="p">(</span><span class="n">spc</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">world</span><span class="p">)</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">])</span></div>

<div class="viewcode-block" id="Mech.update_y_from_y"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.update_y_from_y">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_y_from_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update y if it exists or create it, if it does not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Mech.update_y_from_world"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.update_y_from_world">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_y_from_world</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create y vector in world with values for each species in allspcs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_y_from_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Mech.update_world_from_y"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.update_world_from_y">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_world_from_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update world state from y</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">world</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_y_from_y</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">si</span><span class="p">,</span> <span class="n">spc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">):</span>
            <span class="n">world</span><span class="p">[</span><span class="n">spc</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">si</span><span class="p">]</span></div>

<div class="viewcode-block" id="Mech.set_spcs"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.set_spcs">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_spcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">spcs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set each spcs to values in world and world[&#39;y&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">spcs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_y_from_world</span><span class="p">()</span></div>

<div class="viewcode-block" id="Mech.integrate"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.integrate">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">integrate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">solver_keywords</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments:</span>
<span class="sd">            t0 - starting time in (unit of kinetic rates)</span>
<span class="sd">            t1 - ending time in (unit of kinetic rates)</span>
<span class="sd">            y0 - vector of concentrations (unit of kinetic rates)</span>
<span class="sd">            solver - (optional; default None) string indicating solver approach</span>
<span class="sd">                * None if not provided, defaults to integrator set in</span>
<span class="sd">                  mechanism defintion</span>
<span class="sd">                * &#39;odeint&#39; use odeint with lsoda from ODEPACK</span>
<span class="sd">                  (scipy.integrate.odeint)</span>
<span class="sd">                * &#39;lsoda&#39;, &#39;vode&#39;, &#39;zvode&#39;, &#39;dopri5&#39;, &#39;dopri853&#39; use named</span>
<span class="sd">                   solver with ode object (see scipy.integrate.ode)</span>
<span class="sd">            jac - (optional; default True) Use jacobian to speed up solution</span>
<span class="sd">            verbose - (optional; default False) add additional printing</span>
<span class="sd">            solver_keywords - (optional) solver keywords are specific to each</span>
<span class="sd">                              solver; see scipy.integrate.ode for more details</span>
<span class="sd">                              on keywords</span>
<span class="sd">                * with odeint, defaults to dict(atol=1e-3, rtol=1e-4,</span>
<span class="sd">                  maxstep=1000, hmax=self.world[&#39;DT&#39;], mxords=2, mxordn=2)</span>
<span class="sd">                * with ode, no defaults are set</span>

<span class="sd">        Returns:</span>
<span class="sd">            ts - array of times (start, end)</span>
<span class="sd">            Y - array of states with dimensions (time, spc)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">banded</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">packed</span><span class="p">:</span>
            <span class="n">solver_keywords</span><span class="p">[</span><span class="s1">&#39;uband&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span>
            <span class="n">solver_keywords</span><span class="p">[</span><span class="s1">&#39;lband&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml</span>

        <span class="n">solver_trans</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kpp_lsode</span><span class="o">=</span><span class="s1">&#39;odeint&#39;</span><span class="p">)</span>
        <span class="n">solvers</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;lsoda&#39;</span><span class="p">,</span> <span class="s1">&#39;vode&#39;</span><span class="p">,</span> <span class="s1">&#39;zvode&#39;</span><span class="p">,</span> <span class="s1">&#39;dopri5&#39;</span><span class="p">,</span> <span class="s1">&#39;dop853&#39;</span><span class="p">,</span> <span class="s1">&#39;odeint&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">solver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parsed_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsed</span><span class="p">[</span><span class="s1">&#39;INTEGRATOR&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">solver_trans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parsed_solver</span><span class="p">,</span> <span class="n">parsed_solver</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">solver</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">solvers</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;Solver </span><span class="si">%s</span><span class="s1"> may not exist; if you get an error try one of (</span><span class="si">%s</span><span class="s1">)&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">solvers</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="n">maxstepname</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">odeint</span><span class="o">=</span><span class="s1">&#39;mxstep&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;odeint&#39;</span><span class="p">:</span>
            <span class="n">default_solver_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">atol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">maxstep</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;DT&#39;</span><span class="p">],</span>
                <span class="n">mxords</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mxordn</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">default_solver_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;maxstep&#39;</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">maxstepname</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;max_step&#39;</span><span class="p">)</span>
                <span class="n">solver_keywords</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">solver_keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;col_deriv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drate_exp</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drate_exp_str</span> <span class="o">+</span> <span class="s1">&#39;.T&#39;</span><span class="p">,</span> <span class="s1">&#39;drate_exp&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span>
                <span class="p">)</span>

            <span class="c1"># With full details</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnstr</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Constraints affect rates, but are not seen in outputs &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;with odeint&quot;</span>
                <span class="p">)</span>
                <span class="n">warn</span><span class="p">(</span><span class="n">warnstr</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver_keywords</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">])</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">y0</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
                <span class="n">ddy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddy</span>
                <span class="n">Ystep</span><span class="p">,</span> <span class="n">infodict</span> <span class="o">=</span> <span class="n">itg</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span>
                    <span class="n">dy</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">Dfun</span><span class="o">=</span><span class="p">(</span><span class="n">ddy</span> <span class="k">if</span> <span class="n">jac</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">solver_keywords</span>
                <span class="p">)</span>
                <span class="n">y0</span> <span class="o">=</span> <span class="n">Ystep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span> <span class="n">y0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">infodict</span> <span class="o">=</span> <span class="n">infodict</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_world_from_y</span><span class="p">(</span><span class="n">Ystep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infodict</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Integration successful.&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Message:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infodict</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">pdb</span>
                        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">errstr</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1"> ------------------------------- </span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="o">+</span> <span class="s1">&#39; If running again, you must reset the world &#39;</span>
                    <span class="o">+</span> <span class="s1">&#39;(mech.resetworld())&#39;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">errstr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">solver_keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;col_deriv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drate_exp</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drate_exp_str</span><span class="p">,</span> <span class="s1">&#39;drate_exp&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># New method</span>
            <span class="n">default_solver_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">atol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">maxstep</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">default_solver_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;maxstep&#39;</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">maxstepname</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;max_step&#39;</span><span class="p">)</span>
                <span class="n">solver_keywords</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

            <span class="n">Y</span> <span class="o">=</span> <span class="n">y0</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">ody</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">oddy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver_keywords</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">jac</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">itg</span><span class="o">.</span><span class="n">ode</span><span class="p">(</span><span class="n">ody</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">oddy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">itg</span><span class="o">.</span><span class="n">ode</span><span class="p">(</span><span class="n">ody</span><span class="p">)</span>

            <span class="n">r</span><span class="o">.</span><span class="n">set_initial_value</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t0</span><span class="p">)</span>
            <span class="c1"># def solout(t, y):</span>
            <span class="c1">#     self.world[&#39;t&#39;] = t</span>
            <span class="c1">#     self.update_world_from_y(y)</span>
            <span class="c1">#     self.update_y_from_y(y)</span>
            <span class="c1">#     self.Update_World()</span>
            <span class="c1"># r.set_solout(solout)</span>
            <span class="n">nextt</span> <span class="o">=</span> <span class="n">t1</span>
            <span class="n">r</span><span class="o">.</span><span class="n">stiff</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">r</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">nextt</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">set_integrator</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="o">**</span><span class="n">solver_keywords</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">nextt</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">errstr</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="o">+</span> <span class="p">(</span>
                            <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1"> ------------------------------- &#39;</span>
                            <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> If running again, you must reset the world &#39;</span>
                            <span class="o">+</span> <span class="s1">&#39;(mech.resetworld())&#39;</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">errstr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">nextt</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Update_World</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">forceupdate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_world_from_y</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_y_from_world</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Update_World</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">forceupdate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">set_initial_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">r</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">+</span> <span class="n">verbose</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">successful</span><span class="p">():</span>
                    <span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;Partial step from </span><span class="si">%.0f</span><span class="s1"> to </span><span class="si">%.0f</span><span class="s1"> instead of </span><span class="si">%.0f</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">nextt</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">y</span><span class="p">])</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">r</span>

        <span class="k">return</span> <span class="n">ts</span><span class="p">,</span> <span class="n">Y</span></div>

<div class="viewcode-block" id="Mech.run"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.run">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">solver_keywords</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load solvers with Mech object function (Mech.dy), jacobian (Mech.ddy),</span>
<span class="sd">        and mechanism specific options</span>

<span class="sd">        Optional:</span>
<span class="sd">            solver - (optional; default None) string indicating solver approach</span>
<span class="sd">                * None if not provided, defaults to integrator set in</span>
<span class="sd">                  mechanism defintion</span>
<span class="sd">                * &#39;odeint&#39; use odeint with lsoda from ODEPACK</span>
<span class="sd">                  (scipy.integrate.odeint)</span>
<span class="sd">                * &#39;lsoda&#39;, &#39;vode&#39;, &#39;zvode&#39;, &#39;dopri5&#39;, &#39;dopri853&#39; use named</span>
<span class="sd">                  solver with ode object (see scipy.integrate.ode)</span>

<span class="sd">            tstart - starting time in unit of kinetic rates (optional; default</span>
<span class="sd">                     TSTART in initial values)</span>
<span class="sd">            tend - ending time in unit of kinetic rates (optional; default</span>
<span class="sd">                   TEND in initial values)</span>
<span class="sd">            dt - time step in unit of kinetic rates (optional; default DT in</span>
<span class="sd">                 initial values)</span>
<span class="sd">            jac - Use jacobian to speed up solution (default: True)</span>
<span class="sd">            verbose - add additional printing (optional; default 0)</span>
<span class="sd">                * 0 no additional printing</span>
<span class="sd">                * 1 printing in run command and in first integration call</span>
<span class="sd">                * 2 or above add rpinting in run command and in all integration</span>
<span class="sd">                  calls</span>
<span class="sd">            debug - set to true to enable pdb step-by-step execution</span>
<span class="sd">            solver_keywords - (optional) solver keywords are specific to each</span>
<span class="sd">                              solver; see scipy.integrate.ode for more details</span>
<span class="sd">                              on keywords</span>
<span class="sd">                * with odeint, defaults to dict(atol=1e-3, rtol=1e-4,</span>
<span class="sd">                  maxstep=1000, hmax=self.world[&#39;DT&#39;], mxords=2, mxordn=2)</span>
<span class="sd">                * with ode, no defaults are set</span>
<span class="sd">        Returns:</span>
<span class="sd">            duration of simluation</span>

<span class="sd">        Output:</span>
<span class="sd">            mechname + &#39;.tsv&#39; - file with simulation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">pdb</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

        <span class="n">cfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;CFACTOR&#39;</span><span class="p">]</span>
        <span class="n">run_time0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;atol&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">:</span>
            <span class="n">solver_keywords</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;atol&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;atol&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;rtol&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">:</span>
            <span class="n">solver_keywords</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;rtol&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;rtol&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">tstart</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TSTART&#39;</span><span class="p">,</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TEND&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="mi">24</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DT&#39;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tstart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tstart: &quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tend: &quot;</span><span class="p">,</span> <span class="n">tend</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dt: &quot;</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solver_keywords: &quot;</span><span class="p">,</span> <span class="n">solver_keywords</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Update_World</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">forceupdate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="p">()</span>

        <span class="n">nintegrations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">tend</span><span class="p">:</span>
            <span class="c1"># Get y vector from world state</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">()</span>
            <span class="n">tgt</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">jac</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="o">**</span><span class="n">solver_keywords</span>
            <span class="p">)</span>
            <span class="n">nintegrations</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Set new time to last time of integration</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="c1">#t = t + dt</span>
            <span class="c1"># sync world variables and y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_world_from_y</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># Run updater functions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Update_World</span><span class="p">(</span><span class="n">forceupdate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="p">()</span>

        <span class="n">run_time1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allspcs</span><span class="p">,</span> <span class="n">Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">][</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">][</span><span class="s1">&#39;CFACTOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfactor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">run_time1</span> <span class="o">-</span> <span class="n">run_time0</span></div>

<div class="viewcode-block" id="Mech.add_constraint"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.add_constraint">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constraints are used to prevent concentration changes.</span>
<span class="sd">        Usually, the intent is to alter reaction rates.</span>

<span class="sd">        func - a function that takes a mechanism object</span>
<span class="sd">               and a world dictionary. The function should</span>
<span class="sd">               edit the species in world and in the world y</span>
<span class="sd">               vector to ensure</span>

<span class="sd">        def func_example_nox_constraint(mech, world):</span>
<span class="sd">            TOTALNOx = world[&#39;TOTALNOx&#39;]</span>
<span class="sd">            y = world[&#39;y&#39;]</span>
<span class="sd">            ind_NO, ind_NO2, ind_HO2NO2, ind_NO3, ind_N2O5 = eval(</span>
<span class="sd">                &#39;ind_NO, ind_NO2, ind_HO2NO2, ind_NO3, ind_N2O5&#39;, None, world</span>
<span class="sd">            )</span>
<span class="sd">            fNOx = (TOTALNOx /</span>
<span class="sd">                y[[ind_NO, ind_NO2, ind_HO2NO2, ind_NO3, ind_N2O5]].sum())</span>
<span class="sd">            world[&#39;NO&#39;] = y[ind_NO] = y[ind_NO] * fNOx</span>
<span class="sd">            world[&#39;NO2&#39;] = y[ind_NO2] = y[ind_NO2] * fNOx</span>
<span class="sd">            world[&#39;NO3&#39;] = y[ind_NO3] = y[ind_NO3] * fNOx</span>
<span class="sd">            world[&#39;N2O5&#39;] = y[ind_N2O5] = y[ind_N2O5] * fNOx</span>
<span class="sd">            world[&#39;HO2NO2&#39;] = y[ind_HO2NO2] = y[ind_HO2NO2] * fNOx</span>

<span class="sd">        add_constraint(func_example_nox_constraint)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mech.get_rates"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.get_rates">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Update_World</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_y_from_world</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_rate_const</span><span class="p">()</span>
        <span class="n">rate_const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;rate_const&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_const</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_exp</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_rxn_strs</span><span class="p">(),</span> <span class="n">rate_const</span><span class="p">,</span> <span class="n">rates</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mech.check_rates"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.check_rates">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">lbl</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rates</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%10.2e</span><span class="s1">,</span><span class="si">%10.2e</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">lbl</span><span class="p">))</span></div>

<div class="viewcode-block" id="Mech.print_world"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.print_world">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.8e</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
        <span class="n">cfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CFACTOR&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_expr</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.1f%%</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">out_keys</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=&#39;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">)</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ti</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="k">else</span> <span class="n">cfactor</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_keys</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">format</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ti</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">out_keys</span><span class="p">]))</span></div>

<div class="viewcode-block" id="Mech.plot"><a class="viewcode-back" href="../../api/pykpp.html#pykpp.mech.Mech.plot">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">pykpp</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">pykpp Users Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">pykpp Example Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/pykpp.html">pykpp package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2023, Barron H. Henderson.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>